<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>User Registration & Live Users</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 700px; margin: auto; background: #f9f9f9; }
    input { width: 100%; padding: 8px; margin: 6px 0; border-radius: 4px; border: 1px solid #ccc; }
    button { padding: 10px 16px; border: none; background: #4CAF50; color: white; border-radius: 4px; cursor: pointer; transition: 0.3s; }
    button:hover { background: #45a049; transform: scale(1.05); }
    .msg { margin: 10px 0; color: green; font-weight: bold; transition: 0.5s; }
    .err { color: red; }
    ul { list-style: none; padding: 0; margin-top: 20px; }
    li { padding: 10px; margin-bottom: 6px; cursor: pointer; border-radius: 5px; background: #e3f2fd; color: #0d47a1; transition: 0.3s; }
    li:hover { background: #0d47a1; color: white; transform: translateX(5px); }
    h2, h3 { color: #0d47a1; text-align: center; }
  </style>
</head>
<body>

<h2>User Registration</h2>
<form id="userForm">
  <input name="firstName" placeholder="First Name" required />
  <input name="lastName" placeholder="Last Name" required />
  <input name="mobileNo" placeholder="Mobile No (10 digits)" required />
  <input name="emailId" type="email" placeholder="Email" required />
  <input name="street" placeholder="Street" />
  <input name="city" placeholder="City" />
  <input name="state" placeholder="State" />
  <input name="country" placeholder="Country" />
  <input name="loginId" placeholder="Login ID (8 chars)" required />
  <input name="password" type="password" placeholder="Password" required />
  <button type="submit">Save</button>
</form>

<div id="response" class="msg"></div>

<h3>Live Users</h3>
<ul id="liveUsers"></ul>

<script>
const API_BASE = 'http://localhost:3000'; // ya render/live backend URL
const socket = io(API_BASE);

// Message display
function showMessage(text, isError) {
  const el = $('#response');
  el.text(text).toggleClass('err', !!isError).css('opacity', 1).animate({opacity: 0}, 4000);
}

// Registration form submit
$('#userForm').on('submit', function(e){
  e.preventDefault();
  const formData = {
    firstName: $('[name=firstName]').val(),
    lastName: $('[name=lastName]').val(),
    mobileNo: $('[name=mobileNo]').val(),
    emailId: $('[name=emailId]').val(),
    address: {
      street: $('[name=street]').val(),
      city: $('[name=city]').val(),
      state: $('[name=state]').val(),
      country: $('[name=country]').val()
    },
    loginId: $('[name=loginId]').val(),
    password: $('[name=password]').val()
  };

  $.ajax({
    url: API_BASE + '/api/register',
    method: 'POST',
    contentType: 'application/json',
    data: JSON.stringify(formData),
    success(res){
      showMessage(res.message, false);
      $('#userForm')[0].reset();
      socket.emit('joinRoom', res.userId); // join live_users
    },
    error(xhr){
      const msg = xhr.responseJSON ? xhr.responseJSON.message : 'Server error';
      showMessage('Error: '+msg, true);
    }
  });
});

// Live users update
socket.on('liveUsers', (users) => {
  const ul = $('#liveUsers');
  ul.empty();
  users.forEach(u => {
    const li = $(`<li>${u.email} â€” ${u.socketId}</li>`);
    li.on('click', async () => {
      try {
        const res = await fetch(`${API_BASE}/api/users/${u.email}`);
        const data = await res.json();
        alert(JSON.stringify(data, null, 2));
      } catch(err){
        alert('Error fetching user info');
      }
    });
    ul.append(li);
  });
});
</script>
</body>
</html>
